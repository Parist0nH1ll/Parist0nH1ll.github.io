# Fuzz Linux using Syzkaller

## Compile Linux Kernel

Install dependency 

```
sudo apt install flex bison libelf-dev libssl-dev
```

Download the latest version of linux kernel [here](https://kernel.org/)

```
make mrproper && make clean && make x86_64_defconfig
```

Add the following contents to `.config` file

```
CONFIG_KCOV=y
CONFIG_DEBUG_INFO=y
CONFIG_KASAN=y
CONFIG_KASAN_INLINE=y
CONFIG_CONFIGFS_FS=y
CONFIG_SECURITYFS=y
```

Compile kernel

```
make -j $(nproc) 
```

The kernel will be at `./arch/x86/boot/bzImage`

## Run Custom Kernel With Qemu

https://github.com/google/syzkaller/blob/master/tools/create-buildroot-image.sh

```
qemu-system-x86_64 -m 2048 \
  -hda ./rootfs.ext2 \
  -kernel ./bzImage \
  -append "root=/dev/sda" \
  -serial stdio \
  -net user,hostfwd=tcp::3333-:22  -net nic
```

## Building Syzkaller

Follow the instruction [here](https://github.com/google/syzkaller/blob/master/docs/linux/setup.md#go-and-syzkaller) to build.

For building Syzkaller on arm machine:

```
make TARGETOS=linux TARGETARCH=amd64
```

If cross compile dependency is missing:

```
sudo apt-get install gcc-x86-64-linux-gnu
sudo apt-get install g++-x86-64-linux-gnu
```

Might encounter out of memory while building in VM, use `dmesg` to see the errors.

Write config file

```
{
    "name": "QEMU-x86",
    "target": "linux/amd64",
    "http": ":56700",
    "workdir": "/home/parallels/Desktop/fuzz/workdir",
    "kernel_obj": "/home/parallels/Desktop/Parallels Shared Folders/fedora/linux/linux-6.2.11",
    "syzkaller": "/home/parallels/Desktop/fuzz/syzkaller/",
    "image": "/home/parallels/Desktop/Parallels Shared Folders/fedora/rootfs.ext2",
    "sshkey": "",
    "procs": 2,
    "type": "qemu",
    "vm": {
        "qemu_args": "-append root=/dev/sda ",
        "count": 1,
        "qemu": "/usr/bin/qemu-system-x86_64",
        "kernel": "/home/parallels/Desktop/Parallels Shared Folders/fedora/bzImage",
        "cpu": 1,
        "mem": 2048
    }
}
```

Run syzkaller

```
./bin/syz-manager -config=fuzz.config
```

## Failed Attempts

### Setup Fedora Server

Create disk img

```
qemu-img create -f qcow2 fedora-desktop/fedora.img 5G
```

Download fedora iso [here](https://archives.fedoraproject.org/pub/archive/fedora/linux/releases/32/Server/x86_64/iso/). Then run qemu to install fedora image:

```
qemu-system-aarch64 -m 2048 -accel hvf -cpu host -M virt \
  -bios /opt/homebrew/Cellar/qemu/7.2.1/share/qemu/edk2-aarch64-code.fd \
  -cdrom ./Fedora-Server-dvd-aarch64-38_Beta-1.3.iso \
  -hda fedora-desktop/fedora.img \
  -serial stdio -boot menu=on \
  -net user,hostfwd=tcp::2222-:22 -net nic
```

Set  `PermitRootLogin yes` and add pub key to `.ssh/authorized_keys` generated by `ssh-keygen -t rsa`

```
ssh root@localhost -p 2222
```

After install, start the image by:

```
qemu-system-aarch64 -m 2048 -accel hvf -cpu host -M virt \
  -hda ./fedora-desktop/fedora.img \
  -bios /opt/homebrew/Cellar/qemu/7.2.1/share/qemu/edk2-aarch64-code.fd \
  -serial stdio -boot menu=on \
  -net user,hostfwd=tcp::2222-:22 -net nic
```

Copy initramfs in `/boot/`

```
csp -P 2222 root@localhost:/boot/initramfs-6.2.2-301.fc38.aarch64.img . 
```

### Build Linux Kernel

Use menuconfig to enable:

+ Lodable Module Support
+ File Systems
  + XFS 
+ Kernel Hacking:
  + Compile-time checks and compiler options:
    + Compile with Debug Info
  + Memory debugging
    + Debug VM
    + KASAN: Inline Instrumentation
    + Kernel Memory Leak Detector
  + Kernel Testing and Coverage
    + Fault-Injection Framework
    + Code Coverage for Fuzzing: KCOV

```
make menuconfig
```

### Run Custom Kernel

Run fedora with build kernel (have to specify -bios to run on Mac OS)

Use `df -h` to find the boot path and add it in `-append` for loading custom kernel

```
qemu-system-aarch64 -m 2048 -accel hvf -cpu host -M virt \
  -bios /opt/homebrew/Cellar/qemu/7.2.1/share/qemu/edk2-aarch64-code.fd \
  -append "root=/dev/vda2" \
  -kernel ./vmlinux \
  -initrd ./initramfs-6.2.2-301.fc38.aarch64.img \
  -hda ./fedora-desktop/fedora.img \
  -serial stdio \
  -net user,hostfwd=tcp::2222-:22 -net nic
```

Or you can use the script provided by Syzkaller to build image:

```
sudo apt install debootstrap
wget https://raw.githubusercontent.com/google/syzkaller/master/tools/create-image.sh -O create-image.sh
chmod +x create-image.sh
./create-image.sh -s 1024
```

Run image with custom kernel:

```
qemu-system-x86_64 -m 1G \
  -drive file=/root/fuzz_img/bullseye.img,format=raw \
  -kernel /root/linux/linux-6.2.11/arch/x86/boot/bzImage \
  -append root=/dev/sda \
  -serial stdio -display none \
  -net user,hostfwd=tcp::2222-:22  -net nic
```

Problem with `failed to start raise network interfaces` can be fixed by [this](https://dannyda.com/2021/04/01/how-to-fix-ubuntu-20-04-1-lts-failed-to-start-raise-network-interfaces/), basically need to change the `eth0` in `/etc/network/interface` to what is shown in `ip link`
